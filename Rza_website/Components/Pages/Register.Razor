@page "/Register"
@using Rza_website.Services
@using Rza_website.Models
@inject CustomerService CustomerService
@inject NavigationManager NavigationManager

<link rel="stylesheet" href="~/css/Style.css" />

<div class="login-container">
    <div class="login-box">
        <h2>Register</h2>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="success-message">@message</div>
        }

        <EditForm EditContext="editContext" OnValidSubmit="@RegisterCustomer" FormName="RegisterForm">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="input-group">
                <label for="firstName">First name</label>
                <input type="text" id="firstName" name="firstName" placeholder="Enter your First name" @bind="newCustomer.FirstName" required />
            </div>

            <div class="input-group">
                <label for="lastName">Last name</label>
                <input type="text" id="lastName" name="lastName" placeholder="Enter your Last name" @bind="newCustomer.LastName" required />
            </div>

            <div class="input-group">
                <label for="username">Username</label>
                <InputText @bind-Value=newCustomer.Username />
            </div>

            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="Enter your password" @bind="newCustomer.Password" required />
            </div>

            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" placeholder="Enter your Email" @bind="newCustomer.Email" required />
            </div>

            <div class="input-group">
                <label for="phoneNumber">Phone Number</label>
                <input type="text" id="phoneNumber" name="phoneNumber" placeholder="Enter your Phone Number" @bind="newCustomer.PhoneNumber" required />
            </div>

            <div class="input-group">
                <label for="postcode">Postcode</label>
                <input type="text" id="postcode" name="postcode" placeholder="Enter your Postcode" @bind="newCustomer.Postcode" required />
            </div>

            <button type="submit" class="login-btn">Register</button>
        </EditForm>

        <div class="login-footer">
            <p>Have an account? <a href="/Login">Login here</a></p>
        </div>
    </div>
</div>

@code {
    private Customer newCustomer = new Customer();
    private string message = string.Empty;
    private EditContext editContext;
    

    protected override void OnInitialized()
    {
        editContext = new EditContext(newCustomer);
    }

    private async Task RegisterCustomer()
    {
        if (newCustomer.Username == null)
        {
            Console.WriteLine("USERNAME IS NULL");
        }
        // Check if the username already exists
        if (await CustomerService.UsernameExistsAsync(newCustomer.Username))
        {
            message = "Username already exists. Please choose another.";
            return;
        }

        // Hash the password and add the customer to the database
        newCustomer.Password = CustomerService.HashPassword(newCustomer.Password);
        await CustomerService.AddCustomerAsync(newCustomer);

        // Confirm success and navigate to login
        message = "Registration successful! Please log in.";
        NavigationManager.NavigateTo("/Login", forceLoad: true);
    }
}
